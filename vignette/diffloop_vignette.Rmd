---
title: Analysis of variable DNA loops with diffloop
author: Caleb Lareau & Martin Aryee
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    theme: flatly
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
***

# Overview
The purpose of this document is to describe in greater detail much of the useful functionality implemented in `diffloop`, an `R/Bioconductor` package. As the name suggests, the goal of this package was to create a computational framework to identify differential loops between conditions akin to differential gene expression analyses from RNA-Seq and related transcriptomics data. However, much of the more useful methodology is incorporated *before* one runs differential association (_i.e._ quality control) and after differential loops are called (_e.g._ visualization, correlating differential loops with epigenomic signal and gene expression, etc.). This extended online resource provides a means for understanding these function

Additional steps regarding the quality control ana analysis of similar ENCODE ChIA-PET data can be found [here](https://rpubs.com/caleblareau/diffloop_vignette). 


## On preprocessing

Though outside the scope of `diffloop`, an important component to consider before using this package is the choice of preprocessing associated with the loop data. For this vignette, we used the [mango](https://github.com/dphansti/mango) ChIA-PET pre-processing pipeline importantly specifying the `reportAllPairs = TRUE` flag such that any PET binding two peaks would be retained. However, it may be optimal to process the interaction set together, which requires pre-specifying anchor loci. To this end, we recommend an in-house tool, [hichipper](https://aryeelab.org/hichipper), which enables this and other HiChIP-specific methods.

Regardless of the choice of preprocessing, some basic assumptions about the anchor size have to be made. In most Hi-C pre-processing pipelines, a fixed genome window of 5kb, 20kb, or similar distance is employed. From what we've seen using preprocessing tools, most support some fixed-width padding around a `.narrowPeak` file that is called from `macs2` or a similar peak-caller when an immunoprecipitation is used (in HiChIP and ChIA-PET). Tools such as `mango` and `hichipper` use 500-1,000 bp as anchor pads, though users should consider the question of interest before selecting window padding, etc., for their experimental system. While `diffloop` has functionality to enable anchor padding, in general, this is best employed early in the pre-processing steps using the flags made available in these and other tools. 

## On single-replicate samples 

Akin to `DESeq`, `edgeR`, and related RNA analysis frameworks, replicate samples are essentially *required* to accurately identify differential loops with statistical confidence. However, one can certainly utilize `diffloop` to identify putative differential loops in single replicate settings. For example, suppose you had a `loops()` object called `dat` with 2 samples that that you wanted to compare against each other. While the assumptions needed for variance estimation in the loop counts make computing a p-value or FDR per-loop impossible as we will demonstrate later with replicates, we'd advice the following workflow for find differential loops in single-replicate settings.

```{r singles, eval=FALSE, message=FALSE, warning = FALSE}
dat <- loopsMake("../loopsdata")
dat@rowData$diffCount <- dat@counts[,2] - dat@counts[,1] # per loop differences between sample 1 and 2
df <- summary(dat)
```

**Note:** above are real diffloop commands but are not executable in the lense of the vignette. 

In the code above, the idea is to add a column to the `rowData` slot that is the difference in counts per loop between sample 2 and sample 1, which may be informative for finding differential loops between the two samples. the `summary` command in `diffloop` (when applied to a `loops()` object) results in a `data.frame` of useful information per loop where users can now sort `df` by the `diffCount` column much like any other `data.frame` in R. Again, while single replicate conditions are certainly sub-optimal, we suggest this framework for a simple first pass in this setting. 

## Sample analysis of ENCODE ChIA-PET data / preprocessing

For the remaining contents of this document, we primarily discuss the analysis framework associated with a sample comparison of differential looping between the MCF7 and K562 cancer cell lines. ChIA-PET data made available through the ENCODE project were analyzed using the following workflow--

The raw `.fastq` read files for the POL2 data were preprocessed with the [mango](https://github.com/dphansti/mango) package, an R package that relies on bowtie, bedtools, and MACS2 to align reads, call anchor peaks, and summarize PETs per sample in the ChIA-PET experiment.

```
head -3 *.interactions.all.mango
```
yields-- 
```
chr1    32705184    32708527    chr1    32712484    32715408    4   1
chr1    32705184    32708527    chr1    32755920    32759477    3   1
chr1    32705184    32708527    chr1    32799616    32803060    6   1
```

Another possible format for reads are `.bedpe` files, which are very similar to the output files produced by mango. To use the loopsMake function from a different preprocessing step, have files X.loop_counts.bedpe,Y.loop_counts.bedpe, Z.loop_counts.bedpe in bed_dir for samples = (X,Y,Z) where the first lines should resemble:

```
head -3 *.loop_counts.bedpe
```
yields--
```
1 10002272 10004045 10 120968807 120969483 . 1
1 10002272 10004045 10 99551498 99552470 . 1
1 10002272 10004045 1 10002272 10004045 . 17
```

where the first three columns specify the position (chr:start:stop) of the first anchor, the second three columns specify the position (chr:start:stop) of the secnd anchor, the 7th column is “.” and the 8th column is the number of paired-end reads support that particular PET.

For this vignette, we use the `.mango` output files. 

## Difference between mango and diffloop



## Packages

First, we'll load all the necessary packages for this vignette overview--

```{r packages, cache=FALSE, message=FALSE, warning = FALSE}
library(diffloop)
library(GenomicRanges)
library(ggplot2)
```

## Data structures

We've created a novel `S4` `loops()` object that provides the backbone for housing data and is the input to virtually all functions shown here. Currently, `diffloop` functions only work on this type of object. [Email Caleb](mailto:caleblareau@g.harvard.edu) if you have your loops data in another format that is reasonably common in `R/Bioconductor` workflows and converting it to a `loops()` object isn't straightforward.

## Import / quality control

There are two main functions currently available in `diffloop` used to import loops. Examples of each are discussed [here](https://rpubs.com/caleblareau/diffloop_vignette), but for this vignette, we only use the `loopsMake.mango` function, which imports files that end in `.mango`. 

The nature of the cell lines that we are analyzing in this experimental setting necessitates that regions of the genome likely to be affected by cancer genome rearrangements and copy number alterations could bias differential looping results. To this end, we use the `removeRegion()` function can be called to filter loops that have one or more anchors in a particular region that may be blacklisted. While CNVs likely have some interesting effect on topology that should be explored in the future, we simply remove these regions to avoid a confounded signal where we mis-attribute an apparent difference in topology to a difference better explained by altered CNV.

After removing these regions with CNV alteration, we then will filter loops that are deemed biased from the mango Step 5 function. The diffloop implementation aggregates counts across all samples when apply the mango correction model. Here, we filter all loops with an FDR > 0.01 as implemented in the original mango software.

Finally, we filter loops using the `filterLoops()` function to ensure that loops have at least 2 PETs in at least 2 samples; this filtering step is akin to filtering out lowly expressed genes in RNA-Seq. Failing to do some level of filtering like this heavily influences the pooled variance estimations from `edgeR` and related tools.

The code chunk below shows the basic workflow for importing data and performing the quality control metrics discussed above, including the `dim()` of the loops objects at each filerting step so that one can readily see how loops and anchors get filtered out during this process--

```{r importQC, cache = FALSE, message=FALSE, warning = FALSE}
full <- loopsMake.mango("../data/raw_mango")
dim(full)
full <- updateLDGroups(full, c("K562", "K562", "MCF7", "MCF7"))
samples <- c("HCT116", "K562_r1", "K562_r2", "MCF7_r1", "MCF_r2")
long <- subsetLoops(full, full@rowData$loopWidth >= 5000) # remove and loops that merged together from import
dim(long)
# Remove regions of CNV
k562.cnv <- makeGRangesFromDataFrame(
  setNames(read.table("../data/cnv/K562-CNV.bedLogR")[,1:4],
                                              c("chr", "start", "end", "type")), keep.extra.columns = TRUE)
mcf7.cnv <- makeGRangesFromDataFrame(setNames(read.table("../data/cnv/MCF7-CNV.bedLogR")[,1:4],
                                              c("chr", "start", "end", "type")), keep.extra.columns = TRUE)

cnv.regions <- union(mcf7.cnv[mcols(mcf7.cnv)$type != "normal"],
                     k562.cnv[mcols(k562.cnv)$type != "normal"])
noCNV <- removeRegion(long, rmchr(cnv.regions))
dim(noCNV)

# Filter Mango interactions
mangoSig <- mangoCorrection(noCNV)
dim(mangoSig)

qcLoops <- filterLoops(mangoSig, width = 5000, nreplicates = 2, nsamples = 2)
```

## Differential loop calling

## Modified FDR Calculations

Though the following section hasn't been fully examined, note that the differential loop calling may be biased depending on whether the loops are long/short or perhaps a function of another covariate. To this end, we recommend using the [IHW package](http://bioconductor.org/packages/release/bioc/html/IHW.html) for computing modified false-discovery rates. Given a `loops()` object named `assoc` with a similar 2x2 design, one can run `IHW` and incorporate the results into the `loops` object using a workflow like so--

```{r ihw, warning = FALSE, message = FALSE, eval = FALSE}
library(IHW)
library(DESeq2)

# Do DESeq2 for IHW / FDR 
dsdLoop <- DESeqDataSetFromMatrix(
  countData=assoc@counts,
  colData=assoc@colData,
  design=~ c("type1", "type1", "type2", "type2") )
dsdLoop <- DESeq( dsdLoop )
resLoop <- as.data.frame( results( dsdLoop ) )
resLoop$var <- rowVars( counts(dsdLoop, normalized=TRUE) )

resLoop$edgePval <- assoc@rowData$PValue
resLoop$varGroup <- groups_by_filter(resLoop$var, 6)
ihwRes <- ihw( resLoop$edgePval ~ resLoop$var, alpha=0.1 )

assoc@rowData$IHWadjP <- ihwRes@df$adj_pvalue
diffLoops <- subsetLoops(assoc, assoc@rowData$IHWadjP < 0.1)
```

**Note:** this code is not executed in the analysis. Here, we condition of the variance of the loops using `DESeq2` and suggest that the differential loops called should be independent of the variance. Again, this is just one example for how one can compute modified false discovery rate statistics conditioned on some feature of the loops. This has been only gingerly tested internal to our lab, but other options worth considering may also include the loop width, which would be replaced in the `ihw` function call above. 

## Integration with other epigenomic data

In this section, we walk through an overview of how to incorporate additional forms of epigenetic data in `diffloop`, which includ DNA Methylation, ChIP-Seq, and DNase hypersensitivity. In general, we use these data to 1) annotate and characterize loops and 2) relate epigenetic signal near anchors to other effects in three-dimensional proximity though distal in the linear genome. 

### Annotating loops

Critical functionality in downstream `diffloop` analyses requires the annotation of loops. In particular, we annotate loops based on their assumed transcriptional activity by annotating the loops object with regions of promoters and enhancers. Here, we import enhancers defined by H3K27ac peaks in either cancer sample and use the RefSeq hg19 annotation transcription start sites padded by 1kb as the promoter regions.

```{r annotate, warning = FALSE, message = FALSE, eval = TRUE}
kh3 <- "../data/annotation/K562_H3K27ac.bed"
mh3 <- "../data/annotation/MCF7_H3K27ac.bed"

h3k27ac.k <- rmchr(padGRanges(bedToGRanges(kh3), pad = 1000))
h3k27ac.m <- rmchr(padGRanges(bedToGRanges(mh3), pad = 1000))

enhancer <- union(h3k27ac.m, h3k27ac.k)
promoter <- padGRanges(getHumanTSS(), pad = 1000)
km_anno <- annotateLoops(qcLoops, enhancer = enhancer, promoter = promoter)
```

## Integration with transcriptome data

A core component of understanding the putative function of differential loops is the effect on transcription. Depending on the analysis that is desired, this can be quite tricky to integrate two very different data sets. However, we've provided some basic functionality for linking differential gene expression results from `DESeq2` to enhancer-promoter loops, detailed below. First, consider a rather straightforward analysis framework for performing differential gene expression analyses using `DESeq2`--

```{r deseq, warning = FALSE, message = FALSE}
library(DESeq2)

files <- grep("counts", list.files("../data/rna-seq/"), value = TRUE)
condition <- c("k562", "k562", "k562", "mcf7", "mcf7", "mcf7")
names <- c("k1", "k2", "k3", "m1", "m2", "m3")
sampleTable <- data.frame(sampleName = names, fileName = files, condition = condition)
dds <- DESeqDataSetFromHTSeqCount(sampleTable = sampleTable, directory = "../data/rna-seq/", design = ~condition)

dds <- dds[rowSums(counts(dds)) > 1, ]  #remove zero counts
dds$condition <- factor(dds$condition, levels = c("k562", "mcf7"))
dds <- DESeq(dds)
res <- results(dds)
res <- res[complete.cases(res), ]
resDESeq2 <- res[order(res$pvalue), ]
```

With the `DESeq2` data in a table, we can annotate enhancer-promoter loops with their corresponding gene expression values. To achieve this, sequential execution of the `keepEPloops()` and `annotateLoops.dge()` functions are required. This will add data in the rowData slot that has the transcriptional information associated with the particular loop when `multiple = FALSE`, as we show below.

```
km_res.ep <- keepEPloops(km_anno, enhancer, promoter)
km.linked <- annotateLoops.dge(km_res.ep, resDESeq2, multiple = FALSE)
```

If `multiple = TRUE`, then loops that bridge multiple promoters will be annotated with transcription values. To achieve this, the returning functional value cannot be a loops object since we have to duplicate the loop to accommodate the multiple promoters.

In this code chunk, we also set up a data frame for plotting global trends, including the methylation values at distal regions and promoter regions.

```
df <- summary(km.linked)
df$logFC_bin <- cut(df$logFC, seq(-12, 12, 3))
df$log2FoldChange_bin <- cut(df$log2FoldChange, seq(-20, 20, 5))
```

We use our large data frame to visualize the relationship between increasing strength of enhancer-promoter loops and the increasing relative expression of transcripts that are linked to the loops.

```
loopViolin <- ggplot(df[complete.cases(df) & df$padj < 0.1, ], aes(logFC_bin, log2FoldChange)) + 
    geom_violin(aes(logFC_bin, log2FoldChange), fill = "dodgerblue", trim = TRUE, scale = "width") + 
    geom_hline(yintercept = 0) +  theme_bw() + 
    labs(title = "Differential expression stratified by E-P Loops", x = "log FC Loops", 
    y = "log FC Gene Expression")
loopViolin
```

The plot clearly shows a trend where increasing the logFC of the loops results in a corresponding logFC increase in the corresponding transcript that is the target of the enhancer-promoter loop. While there may be some degree of non-linearity in this plot, we suggest that analyzing more closely-related phenotypes may yield better insights into the role of differential loops on specific gene expression programs. 

## Visualization
We can visualize regions of differential topology using the loopPlot function. Below are two examples of significantly altered topology between the K562 and MCF7 samples.

```{r p1, fig.height=7}
chr1reg <- GRanges(seqnames=c("1"),ranges=IRanges(start=c(11840000),end=c(11980000)))
p1 <- loopPlot(km_anno, chr1reg)
```

This plot highlights the MTHFR gene, which is significantly up-regulated in the K562 cancer cell line. We can see much stronger (line width is linearly proportional to the number of PETs supporting the interaction) E-P loops leading to the promoter of MTHFR as well as multiple enhancer-enhancer loops further localizing enhancer regions in three-dimensional proximity to the MTHFR promoter locus.

We note the color scheme where red loops bridge enhancers and promoters, purple loops bridge two enhancers, orange loops bridge two promoters, blue loops bridge regions of CTCF occupancy, and black have no special color annotation based on the data present.

```{r p2, fig.height=7}
chr14reg <- GRanges(seqnames=c("14"),ranges=IRanges(start=c(35800000),end=c(35890000)))
p14 <- loopPlot(km_anno, chr14reg)
```

The second plot highlights the NFKBIA gene, which is upregulated in breast cancers like MCF7. This loop plot shows several strong enhancer-promoter loops localizing downstream enhancers to the NFKBIA promoter. This change in topology helps explain the upregulation of this gene in MCF7 relative to K562.

# Summary

This vignette was written to demonstrate a more detailed workflow for identifying and analyzing variabile DNA loops with `diffloop`. Moreover, as handling DNA looping data is still rather new, some of the nuances associated with preprocessing discussed above should be carefullly considered. Thought the quality control measures for a set of loops require some thought, a wide variety of options are available in `diffloop` for these to be filterd before differential testing. Ultimately, the integration of extensive epigenetic and transcriptional data to identify and annotate regions of differential loops are the core functionality of the package. The visualizations provide both large-scale trends (e.g. correlations between logFC of loops and the transcription FC) and anecdotal regions of variable topology, as shown in the plots in this vignette. As the availability of DNA looping data continues to grow and experiments are designed to test unique aspects of variable DNA interactions, we expect to add more features to diffloop to further facilitate detailed analyses.

## Session info

```{r sessInfo}
sessionInfo()
```



## Citations

$^1$Hnisz, Denes, et al. "Activation of proto-oncogenes by disruption of
chromosome neighborhoods." Science (2016). <br><br>
$^2$Ji, Xiong, et al. "3D Chromosome Regulatory Landscape of Human Pluripotent
Cells." Cell stem cell (2015).<br><br>
$^3$Phanstiel, D, et al. "Mango: A bias correcting ChIA-PET analysis pipeline."
Bioinformatics (2015). <br><br>
$^4$Robinson, M, et al. "edgeR: a Bioconductor package for differential expression
analysis of digital gene expression data." Bioinformatics (2010). <br><br>
$^5$Law, C, et al. "Voom: precision weights unlock linear model analysis tools
for RNA-seq read counts." Genome Biology (2014). 